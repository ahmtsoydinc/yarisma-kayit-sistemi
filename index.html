<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yarışma Hayvan Kayıt Sistemi v6 (Tam Bulut)</title>
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#1f2937; --text:#e5e7eb; --sub:#9ca3af; --brand:#22c55e; --danger:#ef4444; --warn:#f59e0b; --blue:#2563eb; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,#0b1220 0%,#0f172a 60%,#0b1220 100%);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1250px;margin:32px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:20px}
    h1{font-size:24px;margin:0}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{background:var(--muted);border:1px solid #222;border-radius:12px;padding:10px 14px;cursor:pointer;transition:.2s}
    .tab.active{background:var(--brand);color:#052e16;border-color:transparent;font-weight:600}
    .card{background:linear-gradient(180deg,#111827,#0b1220);border:1px solid #1f2937;border-radius:16px;padding:18px;box-shadow:0 10px 35px rgba(0,0,0,.35)}
    fieldset{border:1px dashed #263246;border-radius:12px;padding:12px;margin:0 0 14px}
    legend{padding:0 6px;color:var(--sub);font-size:12px}
    label{display:block;font-size:13px;color:var(--sub);margin:10px 0 6px}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #22314a;background:#0a1426;color:var(--text)}
    input:focus,select:focus{outline:2px solid #2563eb33;border-color:#2563eb66}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-6{grid-column:span 6}.col-5{grid-column:span 5}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{padding:10px 14px;border-radius:12px;border:1px solid #234;cursor:pointer;background:#16223a;color:#dbeafe}
    button.primary{background:var(--brand);color:#052e16;border-color:transparent;font-weight:700}
    button.ghost{background:#0b1220}
    button.danger{background:var(--danger);color:#fff;border-color:transparent}
    button.warn{background:var(--warn);color:#1f1300;border-color:transparent}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:left;padding:10px 12px;background:#0a1426;border:1px solid #22314a;vertical-align:top}
    th{background:#0e1a30;color:#9fb3c8}
    tr td:first-child,tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tr td:last-child,tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #2a3b58;background:#0b1424;color:#c7d2fe}
    .footer{margin-top:12px;color:#64748b;font-size:12px}
    .hidden{display:none}
    .subtabs{display:flex;gap:8px;margin:8px 0 14px}
    .subtab{padding:8px 10px;border:1px solid #2a3b58;border-radius:10px;background:#0b1424;cursor:pointer}
    .subtab.active{background:var(--blue);color:#ecfeff;border-color:transparent}
    .dropzone{border:2px dashed #2a3b58;border-radius:16px;padding:26px;text-align:center;background:#0b1424;color:#9fb3c8}
    .dropzone.drag{border-color:var(--brand);background:#0f1b31}
    .radio-group{display:flex;gap:8px;flex-wrap:wrap}
    .radio-group button{background:#0b1424;border:1px solid #2a3b58;color:#dbeafe}
    .radio-group button.active{background:var(--brand);color:#052e16;border-color:transparent}
    .note{font-size:12px;color:#9fb3c8}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>🐓 Yarışma Hayvan Kayıt Sistemi <span class="pill">v6</span></h1>
      <nav class="tabs">
        <div class="tab active" data-tab="kayit">Kayıt Formu</div>
        <div class="tab" data-tab="onay">Onay & Liste</div>
        <div class="tab" data-tab="admin">Admin</div>
      </nav>
    </header>

    <!-- Kayıt Formu -->
    <section id="kayit" class="card">
      <form id="formHayvan">
        <fieldset>
          <legend>Katılımcı Bilgileri</legend>
          <div class="row">
            <div class="col-5">
              <label class="req">Ad Soyad</label>
              <input type="text" id="adSoyad" placeholder="Örn: Ahmet Yılmaz" required />
            </div>
            <div class="col-4">
              <label class="req">Cep Telefonu</label>
              <input type="tel" id="telefon" inputmode="numeric" pattern="[0-9]{10,15}" placeholder="5XXXXXXXXX" required />
              <div class="note">Sadece rakam, ülke kodsuz: 5XXXXXXXXX</div>
            </div>
            <div class="col-3">
              <label class="req">Bağlı Bulunduğu Dernek</label>
              <select id="dernek" required>
                <option value="" disabled selected>Dernek Seçiniz...</option>
              </select>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Hayvan Türü ve Kayıt Tipi</legend>
          <div class="row">
            <div class="col-8">
              <label class="req">Hayvan Türü</label>
              <div id="turBtns" class="radio-group">
                <button type="button" data-tur="Tavuk">🐔 Tavuk</button>
                <button type="button" data-tur="Horoz">🐓 Horoz</button>
                <button type="button" data-tur="Ördek">🦆 Ördek</button>
                <button type="button" data-tur="Kaz">🦢 Kaz</button>
                <button type="button" data-tur="Tavşan">🐇 Tavşan</button>
                <button type="button" data-tur="Güvercin">🕊️ Güvercin</button>
              </div>
            </div>
            <div class="col-4">
              <label class="req">Kayıt Tipi</label>
              <div id="kayitTipBtns" class="radio-group">
                <button type="button" data-tip="K">K (Koleksiyon)</button>
                <button type="button" data-tip="T">T (Tek Hayvan)</button>
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Irk / Cins / Renk</legend>
          <div class="row">
            <div class="col-4">
              <label class="req">Irk</label>
              <select id="irk" required>
                <option value="" selected disabled>Seçiniz...</option>
              </select>
            </div>
            <div class="col-4">
              <label class="req">Cins</label>
              <select id="cins" required>
                <option value="" selected disabled>Önce Irk seçiniz</option>
              </select>
            </div>
            <div class="col-4">
              <label class="req">Renk</label>
              <select id="renk" required>
                <option value="" selected disabled>Önce Cins seçiniz</option>
              </select>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Bilezik</legend>
          <div class="row">
            <div class="col-3">
              <label class="req">Bilezik Yılı</label>
              <input type="number" id="yil" min="2000" max="2100" placeholder="2025" required />
            </div>
            <div class="col-8">
              <label class="req">Bilezik Numarası</label>
              <input type="text" id="bilezik" placeholder="TR12345" required />
            </div>
            <div class="col-1" style="display:flex;align-items:end;justify-content:center">
              <span class="pill">TR</span>
            </div>
          </div>
        </fieldset>

        <div class="btns">
          <button type="button" class="primary" id="btnEkle">Listeye Ekle</button>
          <button type="reset" class="ghost">Temizle</button>
        </div>
      </form>
      <div class="footer">Not: Bilezik numarası <strong>TR</strong> ile başlamalıdır.</div>
    </section>

    <!-- Onay & Liste -->
    <section id="onay" class="card hidden">
      <h3>Eklenen Hayvanlar</h3>
      <div id="listeBos">Henüz eklenmiş hayvan yok.</div>
      <div id="listeAlani" class="hidden">
        <table id="tblGecici">
          <thead>
            <tr>
              <th>#</th>
              <th>Ad Soyad</th>
              <th>Telefon</th>
              <th>Dernek</th>
              <th>Tür</th>
              <th>K/T</th>
              <th>Irk</th>
              <th>Cins</th>
              <th>Renk</th>
              <th>Yıl</th>
              <th>Bilezik No</th>
              <th>Sil</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div style="margin-top:10px;display:flex;align-items:center;gap:10px">
          <input type="checkbox" id="onayKutusu" />
          <label for="onayKutusu">Girilen bilgilerin doğruluğunu ve Sergi Koşullarını Onaylıyorum</label>
        </div>

        <div class="btns">
          <button id="btnOnay" class="primary">Onayla ve Kaydet (Bulut)</button>
          <button id="btnBosalt" class="danger">Listeyi Boşalt</button>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="card hidden">
      <div class="row">
        <div class="col-6">
          <label>Admin Girişi (varsayılan şifre: <code>admin</code>)</label>
          <input type="password" id="adminPwd" placeholder="Şifre" />
        </div>
        <div class="col-6" style="display:flex;align-items:end;gap:8px">
          <button id="btnAdminGiris" class="primary">Giriş</button>
          <button id="btnAdminCikis" class="ghost hidden">Çıkış</button>
        </div>
      </div>

      <div id="adminIcerik" class="hidden">
        <div class="subtabs">
          <div class="subtab active" data-subtab="kayitlar">Kayıt Listesi</div>
          <div class="subtab" data-subtab="veriyonetimi">📚 Irk–Cins–Renk</div>
          <div class="subtab" data-subtab="dernek">🏛️ Dernekler</div>
        </div>

        <!-- Kayıt Listesi -->
        <div id="sub_kayitlar">
          <div class="btns" style="justify-content:space-between">
            <div>
              <button id="btnCloudYenile" class="ghost">Buluttan Yenile (Tüm Sekmeler)</button>
            </div>
            <div>
              <button id="btnCSV" class="warn">CSV Olarak İndir</button>
              <button id="btnXLSX" class="primary">Excel (XLSX) Olarak İndir</button>
            </div>
          </div>
          <table id="tblKayitlar">
            <thead>
              <tr>
                <th>#</th>
                <th>Ad Soyad</th>
                <th>Telefon</th>
                <th>Dernek</th>
                <th>Tür</th>
                <th>K/T</th>
                <th>Irk</th>
                <th>Cins</th>
                <th>Renk</th>
                <th>Yıl</th>
                <th>Bilezik No</th>
                <th>Kaydedildi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Veri Yönetimi: Irk–Cins–Renk -->
        <div id="sub_veriyonetimi" class="hidden">
          <h3>Irk–Cins–Renk (Buluttan)</h3>
          <p class="note">Veriler <strong>IrkCinsRenk</strong> sekmesinden otomatik okunur.</p>
          <table id="tblVeri">
            <thead><tr><th>Irk</th><th>Cins</th><th>Renk</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Veri Yönetimi: Dernekler -->
        <div id="sub_dernek" class="hidden">
          <h3>Dernekler (Buluttan)</h3>
          <p class="note">Veriler <strong>Dernekler</strong> sekmesinden otomatik okunur.</p>
          <table id="tblDernek">
            <thead><tr><th>#</th><th>Dernek</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <div class="footer">© 2025 – v6 (Tam Bulut). Kayıtlar Google Sheets'e; listeler buluttan okunur ve cihazda önbelleklenir.</div>
  </div>

  <script>
    // ====== Yapılandırma ======
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx-jCOonpWLRzBCniKC-KbZgvbA14F8wtlBF3ZZ4egK8wtWWZzj8Wld4Vfa5F7MSlx1VQ/exec';
    const SHEET_ID = '1E09uRFI7xyssAkYxX6yblCcJguozh_SqeFEkBsgrBfg';
    const TAB_KAYITLAR = 'Kayitlar';
    const TAB_DERNEKLER = 'Dernekler';
    const TAB_IRK = 'IrkCinsRenk';

    // ====== Yardımcılar ======
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);
    const LS_KAYIT = 'yarisma_kayitlari_v6_cache';
    const LS_VERI = 'irk_cins_renk_v6';
    const LS_DERNEK = 'dernek_listesi_v6';
    const cacheRead = (k,def)=>{ try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def));}catch{return def;} };
    const cacheWrite = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const yaziliTarih = (iso)=>{ if(!iso) return '-'; const d = new Date(iso); return d.toLocaleString('tr-TR'); };
    const csvUrl = (sheetName)=>`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:csv`;

    async function fetchCSV(sheetName){
      const res = await fetch(csvUrl(sheetName), {cache:'no-store'});
      if(!res.ok) throw new Error('CSV okunamadı: '+sheetName);
      const txt = await res.text();
      // Basit CSV ayrıştırma (virgül ayracı varsayımı)
      return txt.split(/\r?\n/).filter(Boolean).map(line=>{
        // Çift tırnak içindeki virgülleri korumak için kaba ayırma
        const parts=[]; let cur=''; let inQ=false;
        for(let i=0;i<line.length;i++){
          const ch=line[i];
          if(ch==='"'){ inQ=!inQ; }
          else if(ch===',' && !inQ){ parts.push(cur); cur=''; continue; }
          cur+=ch;
        }
        parts.push(cur);
        return parts.map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"'));
      });
    }

    // ====== Elemanlar ======
    const tabs = $$('.tab');
    const secKayit = $('#kayit');
    const secOnay = $('#onay');
    const secAdmin = $('#admin');

    const adSoyad = $('#adSoyad');
    const telefon = $('#telefon');
    const dernek = $('#dernek');
    const irk = $('#irk');
    const cins = $('#cins');
    const renk = $('#renk');
    const yil = $('#yil');
    const bilezik = $('#bilezik');
    const btnEkle = $('#btnEkle');

    const tblGeciciBody = $('#tblGecici tbody');
    const listeBos = $('#listeBos');
    const listeAlani = $('#listeAlani');
    const btnOnay = $('#btnOnay');
    const btnBosalt = $('#btnBosalt');
    const onayKutusu = $('#onayKutusu');

    const adminPwd = $('#adminPwd');
    const btnAdminGiris = $('#btnAdminGiris');
    const btnAdminCikis = $('#btnAdminCikis');
    const adminIcerik = $('#adminIcerik');
    const subtabs = $$('.subtab');
    const subKayitlar = $('#sub_kayitlar');
    const subVeriYonetimi = $('#sub_veriyonetimi');
    const subDernek = $('#sub_dernek');

    const tblKayitlarBody = $('#tblKayitlar tbody');
    const btnCSV = $('#btnCSV');
    const btnXLSX = $('#btnXLSX');
    const btnCloudYenile = $('#btnCloudYenile');

    const tblVeriBody = $('#tblVeri tbody');
    const tblDernekBody = $('#tblDernek tbody');

    // Tür ve K/T seçim durumları
    let secTur = '';
    let secTip = '';

    // ====== Sekmeler ======
    tabs.forEach(t=>t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      [secKayit,secOnay,secAdmin].forEach(s=>s.classList.add('hidden'));
      document.getElementById(t.dataset.tab).classList.remove('hidden');
      if(t.dataset.tab==='onay') renderGecici();
      if(t.dataset.tab==='admin' && !adminIcerik.classList.contains('hidden')){
        renderKayitlar(); renderVeriTablosu(); renderDernekTablosu();
      }
    }));

    // Admin subtabs
    subtabs.forEach(st=>st.addEventListener('click',()=>{
      subtabs.forEach(x=>x.classList.remove('active'));
      st.classList.add('active');
      subKayitlar.classList.add('hidden');
      subVeriYonetimi.classList.add('hidden');
      subDernek.classList.add('hidden');
      document.getElementById('sub_'+st.dataset.subtab).classList.remove('hidden');
    }));

    // Tür ve K/T butonları
    $$('#turBtns button').forEach(b=>b.onclick=()=>{ $$('#turBtns button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); secTur=b.dataset.tur; });
    $$('#kayitTipBtns button').forEach(b=>b.onclick=()=>{ $$('#kayitTipBtns button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); secTip=b.dataset.tip; });

    // ====== Buluttan listeleri yükle ======
    async function loadDernekler(){
      try{
        const rows = await fetchCSV(TAB_DERNEKLER);
        const head = rows[0]||[];
        // Dernek sütunu adı "Dernek" veya ilk sütun olabilir
        const idx = head.findIndex(h=>h.trim().toLowerCase()==='dernek');
        const list = rows.slice(1).map(r=> r[idx>-1?idx:0]).filter(Boolean);
        const uniq = [...new Set(list.map(s=>String(s).trim()))];
        cacheWrite(LS_DERNEK, {liste:uniq});
        renderDernekSelect(); renderDernekTablosu();
      }catch(e){ console.warn('Dernekler alınamadı:', e.message); }
    }

    async function loadIrkCinsRenk(){
      try{
        const rows = await fetchCSV(TAB_IRK);
        const head = rows[0]||[];
        const find = (name)=> head.findIndex(h=>h.trim().toLowerCase()===name);
        const iIrk = find('irk');
        const iCins = find('cins');
        const iRenk = find('renk');
        if(iIrk<0 || iCins<0 || iRenk<0) throw new Error('Başlıklar (Irk|Cins|Renk) bulunamadı');
        const map = {};
        rows.slice(1).forEach(r=>{
          const I = String(r[iIrk]||'').trim();
          const C = String(r[iCins]||'').trim();
          const R = String(r[iRenk]||'').trim();
          if(!I||!C||!R) return;
          map[I] = map[I] || {};
          map[I][C] = map[I][C] || [];
          if(!map[I][C].includes(R)) map[I][C].push(R);
        });
        cacheWrite(LS_VERI, map);
        renderIrkSelect(); renderVeriTablosu();
      }catch(e){ console.warn('IrkCinsRenk alınamadı:', e.message); }
    }

    async function loadKayitlar(){
      try{
        const rows = await fetchCSV(TAB_KAYITLAR);
        const head = rows[0]||[]; const idx=(k)=>head.findIndex(h=>h.trim().toLowerCase()===k);
        const iAd=idx('ad soyad'), iTel=idx('telefon'), iDer=idx('dernek'), iTur=idx('tür')>-1?idx('tür'):idx('tur'), iKT=idx('k/t'), iIrk=idx('irk'), iCins=idx('cins'), iRenk=idx('renk'), iYil=idx('yıl')>-1?idx('yıl'):idx('yil'), iBil=idx('bilezik no'), iTime=idx('kaydedildi');
        const list = rows.slice(1).map(r=>({ adSoyad:r[iAd]||'', telefon:r[iTel]||'', dernek:r[iDer]||'', tur:r[iTur]||'', tip:r[iKT]||'', irk:r[iIrk]||'', cins:r[iCins]||'', renk:r[iRenk]||'', yil:r[iYil]||'', bilezik:r[iBil]||'', kayitZamani:r[iTime]||'' }));
        cacheWrite(LS_KAYIT, list); renderKayitlar();
      }catch(e){ console.warn('Kayitlar alınamadı:', e.message); }
    }

    // Açılırları doldur
    function renderDernekSelect(){ const data = cacheRead(LS_DERNEK,{liste:[]}); dernek.innerHTML='<option value="" disabled selected>Dernek Seçiniz...</option>'; data.liste.forEach(d=>{const o=document.createElement('option');o.value=d;o.textContent=d;dernek.appendChild(o);}); }
    function renderIrkSelect(){ const data = cacheRead(LS_VERI,{}); irk.innerHTML='<option value="" disabled selected>Seçiniz...</option>'; Object.keys(data).forEach(i=>{const o=document.createElement('option');o.value=i;o.textContent=i;irk.appendChild(o);}); cins.innerHTML='<option value="" disabled selected>Önce Irk seçiniz</option>'; renk.innerHTML='<option value="" disabled selected>Önce Cins seçiniz</option>'; }

    irk.addEventListener('change',()=>{ const data=cacheRead(LS_VERI,{}); const cinsler=Object.keys(data[irk.value]||{}); cins.innerHTML='<option value="" disabled selected>Seçiniz...</option>'; cinsler.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;cins.appendChild(o);}); renk.innerHTML='<option value="" disabled selected>Önce Cins seçiniz</option>'; });
    cins.addEventListener('change',()=>{ const data=cacheRead(LS_VERI,{}); const renkler=(data[irk.value]||{})[cins.value]||[]; renk.innerHTML='<option value="" disabled selected>Seçiniz...</option>'; renkler.forEach(r=>{const o=document.createElement('option');o.value=r;o.textContent=r;renk.appendChild(o);}); });

    // Bilezik TR kontrolü (TEKRAR TANIM YOK — global değişken kullanılıyor)
    bilezik.addEventListener('input',()=>{ if(!bilezik.value.toUpperCase().startsWith('TR')){ bilezik.value=('TR'+bilezik.value.replace(/^TR/i,'')); } bilezik.value=bilezik.value.toUpperCase().replace(/\s+/g,''); });

    // Geçici liste
    const gecici = [];
    $('#btnBosalt').addEventListener('click',()=>{ if(gecici.length===0) return; if(confirm('Geçici liste silinsin mi?')){ gecici.length=0; renderGecici(); onayKutusu.checked=false; }});

    // Listeye ekle (TEKRAR TANIM YOK — global btnEkle kullanılıyor)
    btnEkle.addEventListener('click',()=>{
      if(!adSoyad.value.trim()) return alert('Ad Soyad gerekli');
      if(!telefon.value.match(/^[0-9]{10,15}$/)) return alert('Telefon 10-15 haneli rakamlardan oluşmalıdır');
      if(!dernek.value) return alert('Dernek seçiniz');
      if(!secTur) return alert('Hayvan türü seçiniz');
      if(!secTip) return alert('K/T seçiniz');
      if(!irk.value||!cins.value||!renk.value) return alert('Irk/Cins/Renk seçiniz');
      if(!yil.value) return alert('Yıl gerekli');
      if(!bilezik.value.toUpperCase().startsWith('TR')) return alert('Bilezik TR ile başlamalıdır');
      const k={ adSoyad:adSoyad.value.trim(), telefon:telefon.value.trim(), dernek:dernek.value, tur:secTur, tip:secTip, irk:irk.value, cins:cins.value, renk:renk.value, yil:yil.value, bilezik:bilezik.value.toUpperCase() };
      gecici.push(k);
      document.getElementById('formHayvan').reset(); $$('#turBtns button').forEach(x=>x.classList.remove('active')); $$('#kayitTipBtns button').forEach(x=>x.classList.remove('active')); secTur=''; secTip=''; renderIrkSelect(); document.querySelector('[data-tab="onay"]').click();
    });

    function renderGecici(){
      const body = tblGeciciBody; body.innerHTML='';
      if(!gecici.length){ listeBos.classList.remove('hidden'); listeAlani.classList.add('hidden'); return; }
      listeBos.classList.add('hidden'); listeAlani.classList.remove('hidden');
      gecici.forEach((k,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${k.adSoyad}</td><td>${k.telefon}</td><td>${k.dernek}</td><td>${k.tur}</td><td>${k.tip}</td><td>${k.irk}</td><td>${k.cins}</td><td>${k.renk}</td><td>${k.yil}</td><td>${k.bilezik}</td><td><button class='danger' data-sil='${i}'>Sil</button></td>`; body.appendChild(tr); });
    }
    document.getElementById('tblGecici').addEventListener('click',(e)=>{ const b=e.target.closest('button[data-sil]'); if(!b) return; const i=+b.dataset.sil; gecici.splice(i,1); renderGecici(); });

    // Buluta kaydet
    document.getElementById('btnOnay').addEventListener('click', async ()=>{
      if(!gecici.length) return alert('Liste boş.');
      if(!onayKutusu.checked) return alert('Onay kutusunu işaretleyiniz.');
      try{
        for(const k of gecici){
          const payload = { adSoyad:k.adSoyad, telefon:k.telefon, dernek:k.dernek, tur:k.tur, tip:k.tip, irk:k.irk, cins:k.cins, renk:k.renk, yil:k.yil, bilezik:k.bilezik };
          const res = await fetch(APPS_SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if(!res.ok) throw new Error('Ağ hatası');
          const txt = await res.text(); if(!/OK/i.test(txt)) console.warn('Beklenmeyen yanıt:', txt);
        }
        gecici.length=0; renderGecici(); onayKutusu.checked=false; alert('Kayıtlar buluta kaydedildi.');
        await loadKayitlar();
      }catch(err){ console.error(err); alert('Kaydetme sırasında bir hata oluştu. İnternet bağlantınızı ve "Dağıtım" ayarlarını kontrol edin.'); }
    });

    // Admin giriş
    btnAdminGiris.addEventListener('click',()=>{ if(adminPwd.value!=='admin') return alert('Hatalı şifre. Varsayılan: admin'); adminIcerik.classList.remove('hidden'); btnAdminCikis.classList.remove('hidden'); renderKayitlar(); renderVeriTablosu(); renderDernekTablosu(); });
    btnAdminCikis.addEventListener('click',()=>{ adminIcerik.classList.add('hidden'); btnAdminCikis.classList.add('hidden'); adminPwd.value=''; });

    // Admin: tabloyu cache'den göster
    function renderKayitlar(){ const data = cacheRead(LS_KAYIT, []); tblKayitlarBody.innerHTML=''; data.forEach((k,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${k.adSoyad}</td><td>${k.telefon}</td><td>${k.dernek}</td><td>${k.tur}</td><td>${k.tip}</td><td>${k.irk}</td><td>${k.cins}</td><td>${k.renk}</td><td>${k.yil}</td><td>${k.bilezik}</td><td>${yaziliTarih(k.kayitZamani)}</td>`; tblKayitlarBody.appendChild(tr); }); }

    // Buluttan yenile (tüm sekmeler)
    btnCloudYenile.addEventListener('click', async ()=>{ await Promise.all([loadKayitlar(), loadDernekler(), loadIrkCinsRenk()]); alert('Buluttan yenilendi.'); });

    // Tablolar: Irk–Cins–Renk ve Dernekler
    function renderVeriTablosu(){ const data=cacheRead(LS_VERI,{}); const rows=[]; Object.keys(data).forEach(i=>{Object.keys(data[i]||{}).forEach(c=>{const rs=data[i][c]||[]; if(!rs.length) rows.push([i,c,'-']); else rs.forEach(r=>rows.push([i,c,r]));});}); tblVeriBody.innerHTML=''; if(!rows.length){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="3">Buluttan veri yükleyin (IrkCinsRenk sekmesi).</td>'; tblVeriBody.appendChild(tr); return;} rows.forEach(([i,c,r])=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${i}</td><td>${c}</td><td>${r}</td>`; tblVeriBody.appendChild(tr);}); }
    function renderDernekTablosu(){ const data=cacheRead(LS_DERNEK,{liste:[]}); tblDernekBody.innerHTML=''; if(!data.liste.length){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="2">Buluttan veri yükleyin (Dernekler sekmesi).</td>'; tblDernekBody.appendChild(tr); return;} data.liste.forEach((d,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${d}</td>`; tblDernekBody.appendChild(tr); }); }

    // ==== Basit Otomatik Testler (konsola yazar) ====
    function runSelfTests(){
      try{
        console.group('[TEST] v6 self-check');
        console.assert(bilezik && typeof bilezik === 'object', 'bilezik alanı bulunmalı');
        const prev = bilezik.value;
        bilezik.value = '12345';
        bilezik.dispatchEvent(new Event('input'));
        console.assert(/^TR/i.test(bilezik.value), 'Bilezik TR ile başlamalı');
        bilezik.value = prev; // geri al

        console.assert(btnEkle && typeof btnEkle === 'object', 'btnEkle bulunmalı');
        console.assert(/^[0-9]{10,15}$/.test('5551234567'), 'Telefon regex örnek testi (5551234567)');
        console.groupEnd();
      }catch(e){ console.error('Self-tests hata:', e); }
    }

    // İlk yükleme: buluttan verileri getir + önbelleğe yaz + self tests
    window.addEventListener('DOMContentLoaded', async ()=>{
      renderDernekSelect(); renderIrkSelect(); // önce cache'dekini yükle (boş olabilir)
      await Promise.all([loadDernekler(), loadIrkCinsRenk(), loadKayitlar()]);
      runSelfTests();
    });
  </script>
</body>
</html>
